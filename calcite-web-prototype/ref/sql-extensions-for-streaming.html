<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>Apache Calcite : SQL Extensions for Streaming</title>
        <meta name="description" content="A Dynamic Data Management Framework">
        <!-- jQuery -->
        <script type="text/javascript" src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,600italic,700italic,400,600,700' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:300,400,500,600,700' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="http://milinda.pathirage.org/calcite-web-prototype//css/syntax.css">
        <link rel="stylesheet" href="http://milinda.pathirage.org/calcite-web-prototype//css/main.css">
    </head>
    <body>
      <nav class="navbar navbar-default navbar-static-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://milinda.pathirage.org/calcite-web-prototype//"><img src="http://milinda.pathirage.org/calcite-web-prototype//images/calcite-logo.png"/>Apache Calcite</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Apache <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li><a href="#">How Apache Works</a></li>
                <li><a href="#">Foundation</a></li>
                <li><a href="#">Sponsoring Apache</a></li>
                <li><a href="#">Thanks</a></li>
              </ul>
            </li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>


        <div class="container main-container">
            <div class=row-fluid>
                
                
                    <div id=navigation class=col-sm-3>
                        <ul class="nav nav-list sd-nav">
    
        
        

        
            
                <li class=nav-header>Project</li>
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//proj/incubator-proposal.html">Incubator Proposal</a></li>
        
    
        
        

        
    
        
        

        
            
                <li class=nav-header>Tutorials</li>
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//tut/csv-adapter.html">CSV Adapter</a></li>
        
    
        
        

        
            
                <li class=nav-header>Reference</li>
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//ref/sql-extensions-for-streaming.html">SQL Extensions for Streaming</a></li>
        
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//ref/sql-language-reference.html">SQL Language Reference</a></li>
        
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//ref/json-model.html">JSON Model</a></li>
        
    
        
        

        
            
                <li class=nav-header>Community</li>
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//com/source-repository.html">Source Repository</a></li>
        
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//com/committers.html">Committers</a></li>
        
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//com/bugs.html">Bugs</a></li>
        
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//com/mailing-lists.html">Mailing Lists</a></li>
        
    
        
        

        
    
        
        

        
            
                <li class=nav-header>Downloads</li>
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//down/092incubating.html">0.9.2-incubating</a></li>
        
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//down/091incubating.html">0.9.1-incubating</a></li>
        
    
<!-- List additional links. It is recommended to add a divider
    e.g. <li class=divider></li> first to break up the content. -->
</ul>

                    </div>

                    <div id=content class=col-sm-9>
                        <div class=page-header>
    <h2>SQL Extensions for Streaming
        
    </h2>
</div>

<h2 id="introduction">Introduction</h2>

<p>Streams are collections to records that flow continuously, and forever.
Unlike tables, they are not typically stored on disk, but flow over the
network and are held for short periods of time in memory.</p>

<p>Streams complement tables because they represent what is happening in the
present and future of the enterprise whereas tables represent the past.
It is very common for a stream to be archived into a table.</p>

<p>Like tables, you often want to query streams in a high-level language
based on relational algebra, validated according to a schema, and optimized
to take advantage of available resources and algorithms.</p>

<p>Calcite&#39;s SQL is an extension to standard SQL, not another &#39;SQL-like&#39; language.
The distinction is important, for several reasons:</p>

<ul>
<li>Streaming SQL is easy to learn for anyone who knows regular SQL.</li>
<li>The semantics are clear, because we aim to produce the same results on a
stream as if the same data were in a table.</li>
<li>You can write queries that combine streams and tables (or the history of
a stream, which is basically an in-memory table).</li>
<li>Lots of existing tools can generate standard SQL.</li>
</ul>

<h2 id="an-example-schema">An example schema</h2>

<p>Our streaming SQL examples use the following schema:</p>

<ul>
<li><code>Orders (rowtime, productId, orderId, units)</code> - a stream and a table</li>
<li><code>Products (rowtime, productId, name)</code> - a table</li>
<li><code>Shipments (rowtime, orderId)</code> - a stream</li>
</ul>

<h2 id="a-simple-query">A simple query</h2>

<p>Let&#39;s start with the simplest streaming query:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">STREAM</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">Orders</span><span class="p">;</span>

  <span class="n">rowtime</span> <span class="o">|</span> <span class="n">productId</span> <span class="o">|</span> <span class="n">orderId</span> <span class="o">|</span> <span class="n">units</span>
<span class="c1">----------+-----------+---------+-------</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">30</span> <span class="o">|</span>       <span class="mi">5</span> <span class="o">|</span>     <span class="mi">4</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">05</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>       <span class="mi">6</span> <span class="o">|</span>     <span class="mi">1</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">05</span> <span class="o">|</span>        <span class="mi">20</span> <span class="o">|</span>       <span class="mi">7</span> <span class="o">|</span>     <span class="mi">2</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">07</span> <span class="o">|</span>        <span class="mi">30</span> <span class="o">|</span>       <span class="mi">8</span> <span class="o">|</span>    <span class="mi">20</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>       <span class="mi">9</span> <span class="o">|</span>     <span class="mi">6</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>      <span class="mi">10</span> <span class="o">|</span>     <span class="mi">1</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">30</span> <span class="o">|</span>        <span class="mi">40</span> <span class="o">|</span>      <span class="mi">11</span> <span class="o">|</span>    <span class="mi">12</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">11</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>      <span class="mi">12</span> <span class="o">|</span>     <span class="mi">4</span>
</code></pre></div>
<p>This query reads all columns and rows from the <code>Orders</code> stream.
Like any streaming query, it never terminates. It outputs a record whenever
a record arrives in <code>Orders</code>.</p>

<p>Type <code>Control-C</code> to terminate the query.</p>

<p>The <code>STREAM</code> keyword is the main extension in streaming SQL. It tells the
system that you are interested in incoming orders, not existing ones. The query</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">Orders</span><span class="p">;</span>

  <span class="n">rowtime</span> <span class="o">|</span> <span class="n">productId</span> <span class="o">|</span> <span class="n">orderId</span> <span class="o">|</span> <span class="n">units</span>
<span class="c1">----------+-----------+---------+-------</span>
 <span class="mi">08</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>       <span class="mi">1</span> <span class="o">|</span>     <span class="mi">3</span>
 <span class="mi">08</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">10</span> <span class="o">|</span>        <span class="mi">20</span> <span class="o">|</span>       <span class="mi">2</span> <span class="o">|</span>     <span class="mi">1</span>
 <span class="mi">09</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">21</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>       <span class="mi">3</span> <span class="o">|</span>    <span class="mi">10</span>
 <span class="mi">09</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">44</span> <span class="o">|</span>        <span class="mi">30</span> <span class="o">|</span>       <span class="mi">4</span> <span class="o">|</span>     <span class="mi">2</span>

<span class="mi">4</span> <span class="n">records</span> <span class="n">returned</span><span class="p">.</span>
</code></pre></div>
<p>is also valid, but will print out all existing orders and then terminate. We
call it a <em>relational</em> query, as opposed to <em>streaming</em>. It has traditional
SQL semantics.</p>

<p><code>Orders</code> is special, in that it has both a stream and a table. If you try to run
a streaming query on a table, or a relational query on a stream, Calcite gives
an error:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">Shipments</span><span class="p">;</span>
<span class="n">ERROR</span><span class="p">:</span> <span class="n">Cannot</span> <span class="k">convert</span> <span class="n">stream</span> <span class="s1">&#39;SHIPMENTS&#39;</span> <span class="k">to</span> <span class="n">a</span> <span class="k">table</span>

<span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">STREAM</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">Products</span><span class="p">;</span>
<span class="n">ERROR</span><span class="p">:</span> <span class="n">Cannot</span> <span class="k">convert</span> <span class="k">table</span> <span class="s1">&#39;PRODUCTS&#39;</span> <span class="k">to</span> <span class="n">a</span> <span class="n">stream</span>
</code></pre></div>
<h1 id="filtering-rows">Filtering rows</h1>

<p>Just as in regular SQL, you use a <code>WHERE</code> clause to filter rows:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">STREAM</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">Orders</span>
<span class="k">WHERE</span> <span class="n">units</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">;</span>

  <span class="n">rowtime</span> <span class="o">|</span> <span class="n">productId</span> <span class="o">|</span> <span class="n">orderId</span> <span class="o">|</span> <span class="n">units</span>
<span class="c1">----------+-----------+---------+-------</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">30</span> <span class="o">|</span>       <span class="mi">5</span> <span class="o">|</span>     <span class="mi">4</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">07</span> <span class="o">|</span>        <span class="mi">30</span> <span class="o">|</span>       <span class="mi">8</span> <span class="o">|</span>    <span class="mi">20</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>       <span class="mi">9</span> <span class="o">|</span>     <span class="mi">6</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">30</span> <span class="o">|</span>        <span class="mi">40</span> <span class="o">|</span>      <span class="mi">11</span> <span class="o">|</span>    <span class="mi">12</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">11</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>      <span class="mi">12</span> <span class="o">|</span>     <span class="mi">4</span>
</code></pre></div>
<h1 id="projecting-expressions">Projecting expressions</h1>

<p>Use expressions in the <code>SELECT</code> clause to choose which columns to return or
compute expressions:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">STREAM</span> <span class="n">rowtime</span><span class="p">,</span>
  <span class="s1">&#39;An order for &#39;</span> <span class="o">||</span> <span class="n">units</span> <span class="o">||</span> <span class="s1">&#39; &#39;</span>
    <span class="o">||</span> <span class="k">CASE</span> <span class="n">units</span> <span class="k">WHEN</span> <span class="mi">1</span> <span class="k">THEN</span> <span class="s1">&#39;unit&#39;</span> <span class="k">ELSE</span> <span class="s1">&#39;units&#39;</span> <span class="k">END</span>
    <span class="o">||</span> <span class="s1">&#39; of product #&#39;</span> <span class="o">||</span> <span class="n">productId</span> <span class="k">AS</span> <span class="n">description</span>
<span class="k">FROM</span> <span class="n">Orders</span><span class="p">;</span>

  <span class="n">rowtime</span> <span class="o">|</span> <span class="n">description</span>
<span class="c1">----------+---------------------------------------</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="n">An</span> <span class="k">order</span> <span class="k">for</span> <span class="mi">4</span> <span class="n">units</span> <span class="k">of</span> <span class="n">product</span> <span class="o">#</span><span class="mi">30</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">05</span> <span class="o">|</span> <span class="n">An</span> <span class="k">order</span> <span class="k">for</span> <span class="mi">1</span> <span class="n">unit</span> <span class="k">of</span> <span class="n">product</span> <span class="o">#</span><span class="mi">10</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">05</span> <span class="o">|</span> <span class="n">An</span> <span class="k">order</span> <span class="k">for</span> <span class="mi">2</span> <span class="n">units</span> <span class="k">of</span> <span class="n">product</span> <span class="o">#</span><span class="mi">20</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">07</span> <span class="o">|</span> <span class="n">An</span> <span class="k">order</span> <span class="k">for</span> <span class="mi">20</span> <span class="n">units</span> <span class="k">of</span> <span class="n">product</span> <span class="o">#</span><span class="mi">30</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="n">An</span> <span class="k">order</span> <span class="k">by</span> <span class="mi">6</span> <span class="n">units</span> <span class="k">of</span> <span class="n">product</span> <span class="o">#</span><span class="mi">10</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span> <span class="n">An</span> <span class="k">order</span> <span class="k">by</span> <span class="mi">1</span> <span class="n">unit</span> <span class="k">of</span> <span class="n">product</span> <span class="o">#</span><span class="mi">10</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">30</span> <span class="o">|</span> <span class="n">An</span> <span class="k">order</span> <span class="k">for</span> <span class="mi">12</span> <span class="n">units</span> <span class="k">of</span> <span class="n">product</span> <span class="o">#</span><span class="mi">40</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">11</span> <span class="o">|</span> <span class="n">An</span> <span class="k">order</span> <span class="k">by</span> <span class="mi">4</span> <span class="n">units</span> <span class="k">of</span> <span class="n">product</span> <span class="o">#</span><span class="mi">10</span>
</code></pre></div>
<p>We recommend that you always include the <code>rowtime</code> column in the <code>SELECT</code>
clause. Having a sorted timestamp in each stream and streaming query makes it
possible to do advanced calculations later, such as <code>GROUP BY</code> and <code>JOIN</code>.</p>

<h1 id="tumbling-windows">Tumbling windows</h1>

<p>There are several ways to compute aggregate functions on streams. The
differences are:</p>

<ul>
<li>How many rows come out for each row in?</li>
<li>Does each incoming value appear in one total, or more?</li>
<li>What defines the &quot;window&quot;, the set of rows that contribute to a given output row?</li>
<li>Is the result a stream or a relation?</li>
</ul>

<p>First we&#39;ll look a <em>tumbling window</em>, which is defined by a streaming
<code>GROUP BY</code>. Here is an example:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">STREAM</span> <span class="n">FLOOR</span><span class="p">(</span><span class="n">rowtime</span> <span class="k">TO</span> <span class="n">HOUR</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rowtime</span><span class="p">,</span>
  <span class="n">productId</span><span class="p">,</span>
  <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="k">c</span><span class="p">,</span>
  <span class="k">SUM</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="k">AS</span> <span class="n">units</span>
<span class="k">FROM</span> <span class="n">Orders</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">FLOOR</span><span class="p">(</span><span class="n">rowtime</span> <span class="k">TO</span> <span class="n">HOUR</span><span class="p">),</span> <span class="n">productId</span><span class="p">;</span>

  <span class="n">rowtime</span> <span class="o">|</span> <span class="n">productId</span> <span class="o">|</span>       <span class="k">c</span> <span class="o">|</span> <span class="n">units</span>
<span class="c1">----------+-----------+---------+-------</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">30</span> <span class="o">|</span>       <span class="mi">2</span> <span class="o">|</span>    <span class="mi">24</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>       <span class="mi">1</span> <span class="o">|</span>     <span class="mi">1</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">20</span> <span class="o">|</span>       <span class="mi">1</span> <span class="o">|</span>     <span class="mi">7</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>       <span class="mi">3</span> <span class="o">|</span>    <span class="mi">11</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">40</span> <span class="o">|</span>       <span class="mi">1</span> <span class="o">|</span>    <span class="mi">12</span>
</code></pre></div>
<p>The result is a stream. At 11 o&#39;clock, Calcite emits a sub-total for every
<code>productId</code> that had an order since 10 o&#39;clock. At 12 o&#39;clock, it will emit
the orders that occurred between 11:00 and 12:00. Each input row contributes to
only one output row.</p>

<p>How did Calcite know that the 10:00:00 sub-totals were complete at 11:00:00,
so that it could emit them? It knows that <code>rowtime</code> is increasing, and it knows
that <code>FLOOR(rowtime TO HOUR)</code> is also increasing. So, once it has seen a row
at or after 11:00:00, it will never see a row that will contribute to a 10:00:00
total.</p>

<p>A column or expression that is increasing or decreasing is said to be
<em>monotonic</em>. Without a monotonic expression in the <code>GROUP BY</code> clause, Calcite is
not able to make progress, and it will not allow the query:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">STREAM</span> <span class="n">productId</span><span class="p">,</span>
<span class="o">&gt;</span>   <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="k">c</span><span class="p">,</span>
<span class="o">&gt;</span>   <span class="k">SUM</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="k">AS</span> <span class="n">units</span>
<span class="o">&gt;</span> <span class="k">FROM</span> <span class="n">Orders</span>
<span class="o">&gt;</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">productId</span><span class="p">;</span>
<span class="n">ERROR</span><span class="p">:</span> <span class="n">Streaming</span> <span class="n">aggregation</span> <span class="n">requires</span> <span class="k">at</span> <span class="n">least</span> <span class="n">one</span> <span class="n">monotonic</span> <span class="n">expression</span> <span class="k">in</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">clause</span>
</code></pre></div>
<p>Monotonic columns need to be declared in the schema. The monotonicity is
enforced when records enter the stream and assumed by queries that read from
that stream. We recommend that you give each stream a timestamp column called
<code>rowtime</code>, but you can declare others, <code>orderId</code>, for example.</p>

<h1 id="filtering-after-aggregation">Filtering after aggregation</h1>

<p>As in standard SQL, you can apply a <code>HAVING</code> clause to filter rows emitted by
a streaming <code>GROUP BY</code>:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">STREAM</span> <span class="n">FLOOR</span><span class="p">(</span><span class="n">rowtime</span> <span class="k">TO</span> <span class="n">HOUR</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rowtime</span><span class="p">,</span>
  <span class="n">productId</span>
<span class="k">FROM</span> <span class="n">Orders</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">FLOOR</span><span class="p">(</span><span class="n">rowtime</span> <span class="k">TO</span> <span class="n">HOUR</span><span class="p">),</span> <span class="n">productId</span>
<span class="k">HAVING</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">OR</span> <span class="k">SUM</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">;</span>

  <span class="n">rowtime</span> <span class="o">|</span> <span class="n">productId</span>
<span class="c1">----------+-----------</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">30</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">10</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">40</span>
</code></pre></div>
<h1 id="sub-queries,-views-and-sql&#39;s-closure-property">Sub-queries, views and SQL&#39;s closure property</h1>

<p>The previous <code>HAVING</code> query can be expressed using a <code>WHERE</code> clause on a
sub-query:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">STREAM</span> <span class="n">rowtime</span><span class="p">,</span> <span class="n">productId</span>
<span class="k">FROM</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">FLOOR</span><span class="p">(</span><span class="n">rowtime</span> <span class="k">TO</span> <span class="n">HOUR</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rowtime</span><span class="p">,</span>
    <span class="n">productId</span><span class="p">,</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="k">c</span><span class="p">,</span>
    <span class="k">SUM</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="k">AS</span> <span class="n">su</span>
  <span class="k">FROM</span> <span class="n">Orders</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">FLOOR</span><span class="p">(</span><span class="n">rowtime</span> <span class="k">TO</span> <span class="n">HOUR</span><span class="p">),</span> <span class="n">productId</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="k">c</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">OR</span> <span class="n">su</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">;</span>

  <span class="n">rowtime</span> <span class="o">|</span> <span class="n">productId</span>
<span class="c1">----------+-----------</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">30</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">10</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">40</span>
</code></pre></div>
<p><code>HAVING</code> was introduced in the early days of SQL, when a way was needed to
perform a filter <em>after</em> aggregation. (Recall that <code>WHERE</code> filters rows before
they enter the <code>GROUP BY</code> clause.)</p>

<p>Since then, SQL has become a mathematically closed language, which means that
any operation you can perform on a table can also perform on a query.</p>

<p>The <em>closure property</em> of SQL is extremely powerful. Not only does it render
<code>HAVING</code> obsolete (or, at least, reduce it to syntactic sugar), it makes views
possible:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">HourlyOrderTotals</span> <span class="p">(</span><span class="n">rowtime</span><span class="p">,</span> <span class="n">productId</span><span class="p">,</span> <span class="k">c</span><span class="p">,</span> <span class="n">su</span><span class="p">)</span> <span class="k">AS</span>
  <span class="k">SELECT</span> <span class="n">FLOOR</span><span class="p">(</span><span class="n">rowtime</span> <span class="k">TO</span> <span class="n">HOUR</span><span class="p">),</span>
    <span class="n">productId</span><span class="p">,</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">),</span>
    <span class="k">SUM</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">Orders</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">FLOOR</span><span class="p">(</span><span class="n">rowtime</span> <span class="k">TO</span> <span class="n">HOUR</span><span class="p">),</span> <span class="n">productId</span><span class="p">;</span>

<span class="k">SELECT</span> <span class="n">STREAM</span> <span class="n">rowtime</span><span class="p">,</span> <span class="n">productId</span>
<span class="k">FROM</span> <span class="n">HourlyOrderTotals</span>
<span class="k">WHERE</span> <span class="k">c</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">OR</span> <span class="n">su</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">;</span>

  <span class="n">rowtime</span> <span class="o">|</span> <span class="n">productId</span>
<span class="c1">----------+-----------</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">30</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">10</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">40</span>
</code></pre></div>
<p>Sub-queries in the <code>FROM</code> clause are sometimes referred to as &quot;inline views&quot;,
but really, nested queries are more fundamental. Views are just a convenient
way to carve your SQL into manageable chunks.</p>

<p>Many people find that nested queries and views are even more useful on streams
than they are on relations. Streaming queries are pipelines of
operators all running continuously, and often those pipelines get quite long.
Nested queries and views help to express and manage those pipelines.</p>

<p>And, by the way, a <code>WITH</code> clause can accomplish the same as a sub-query or
a view:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">WITH</span> <span class="n">HourlyOrderTotals</span> <span class="p">(</span><span class="n">rowtime</span><span class="p">,</span> <span class="n">productId</span><span class="p">,</span> <span class="k">c</span><span class="p">,</span> <span class="n">su</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">FLOOR</span><span class="p">(</span><span class="n">rowtime</span> <span class="k">TO</span> <span class="n">HOUR</span><span class="p">),</span>
    <span class="n">productId</span><span class="p">,</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">),</span>
    <span class="k">SUM</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">Orders</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">FLOOR</span><span class="p">(</span><span class="n">rowtime</span> <span class="k">TO</span> <span class="n">HOUR</span><span class="p">),</span> <span class="n">productId</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">STREAM</span> <span class="n">rowtime</span><span class="p">,</span> <span class="n">productId</span>
<span class="k">FROM</span> <span class="n">HourlyOrderTotals</span>
<span class="k">WHERE</span> <span class="k">c</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">OR</span> <span class="n">su</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">;</span>

  <span class="n">rowtime</span> <span class="o">|</span> <span class="n">productId</span>
<span class="c1">----------+-----------</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">30</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">10</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">40</span>
</code></pre></div>
<h2 id="converting-between-streams-and-relations">Converting between streams and relations</h2>

<p>Look back at the definition of the <code>HourlyOrderTotals</code> view.
Is the view a stream or a relation?</p>

<p>It does not contain the <code>STREAM</code> keyword, so it is a relation.
However, it is a relation that can be converted into a stream.</p>

<p>You can use it in both relational and streaming queries:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="o">#</span> <span class="n">A</span> <span class="n">relation</span><span class="p">;</span> <span class="n">will</span> <span class="n">query</span> <span class="n">the</span> <span class="n">historic</span> <span class="n">Orders</span> <span class="k">table</span><span class="p">.</span>
<span class="o">#</span> <span class="k">Returns</span> <span class="n">the</span> <span class="n">largest</span> <span class="nb">number</span> <span class="k">of</span> <span class="n">product</span> <span class="o">#</span><span class="mi">10</span> <span class="n">ever</span> <span class="n">sold</span> <span class="k">in</span> <span class="n">one</span> <span class="n">hour</span><span class="p">.</span>
<span class="k">SELECT</span> <span class="k">max</span><span class="p">(</span><span class="n">su</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">HourlyOrderTotals</span>
<span class="k">WHERE</span> <span class="n">productId</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

<span class="o">#</span> <span class="n">A</span> <span class="n">stream</span><span class="p">;</span> <span class="n">will</span> <span class="n">query</span> <span class="n">the</span> <span class="n">Orders</span> <span class="n">stream</span><span class="p">.</span>
<span class="o">#</span> <span class="k">Returns</span> <span class="k">every</span> <span class="n">hour</span> <span class="k">in</span> <span class="n">which</span> <span class="k">at</span> <span class="n">least</span> <span class="n">one</span> <span class="n">product</span> <span class="o">#</span><span class="mi">10</span> <span class="n">was</span> <span class="n">sold</span><span class="p">.</span>
<span class="k">SELECT</span> <span class="n">STREAM</span> <span class="n">rowtime</span>
<span class="k">FROM</span> <span class="n">HourlyOrderTotals</span>
<span class="k">WHERE</span> <span class="n">productId</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div>
<p>This approach is not limited to views and sub-queries.
Following the approach set out in CQL [<a href="#ref1">1</a>], every query
in streaming SQL is defined as a relational query and converted to a stream
using the <code>STREAM</code> keyword in the top-most <code>SELECT</code>.</p>

<p>If the <code>STREAM</code> keyword is present in sub-queries or view definitions, it has no
effect.</p>

<p>At query preparation time, Calcite figures out whether the relations referenced
in the query can be converted to streams or historical relations.</p>

<p>Sometimes a stream makes available some of its history (say the last 24 hours of
data in an Apache Kafka [<a href="#ref2">2</a>] topic)
but not all. At run time, Calcite figures out whether there is sufficient
history to run the query, and if not, gives an error.</p>

<h2 id="hopping-windows">Hopping windows</h2>

<p>Previously we saw how to define a tumbling window using a <code>GROUP BY</code> clause.
Each record contributed to a single sub-total record, the one containing its
hour and product id.</p>

<p>But suppose we want to emit, every hour, the number of each product ordered over
the past three hours. To do this, we use <code>SELECT ... OVER</code> and a sliding window
to combine multiple tumbling windows.</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">STREAM</span> <span class="n">rowtime</span><span class="p">,</span>
  <span class="n">productId</span><span class="p">,</span>
  <span class="k">SUM</span><span class="p">(</span><span class="n">su</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">w</span> <span class="k">AS</span> <span class="n">su</span><span class="p">,</span>
  <span class="k">SUM</span><span class="p">(</span><span class="k">c</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">w</span> <span class="k">AS</span> <span class="k">c</span>
<span class="k">FROM</span> <span class="n">HourlyTotals</span>
<span class="n">WINDOW</span> <span class="n">w</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">rowtime</span>
  <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">productId</span>
  <span class="n">RANGE</span> <span class="nb">INTERVAL</span> <span class="s1">&#39;2&#39;</span> <span class="n">HOUR</span> <span class="n">PRECEDING</span><span class="p">)</span>
</code></pre></div>
<p>This query uses the <code>HourlyOrderTotals</code> view defined previously.
The 2 hour interval combines the totals timestamped 09:00:00, 10:00:00 and
11:00:00 for a particular product into a single total timestamped 11:00:00 and
summarizing orders for that product between 09:00:00 and 12:00:00.</p>

<h2 id="limitations-of-tumbling-and-hopping-windows">Limitations of tumbling and hopping windows</h2>

<p>In the present syntax, we acknowledge that it is not easy to create certain
kinds of windows.</p>

<p>First, let&#39;s consider tumbling windows over complex periods.</p>

<p>The <code>FLOOR</code> and <code>CEIL</code> functions make is easy to create a tumbling window that
emits on a whole time unit (say every hour, or every minute) but less easy to
emit, say, every 15 minutes. One could imagine an extension to the <code>FLOOR</code>
function that emits unique values on just about any periodic basis (say in 11
minute intervals starting from midnight of the current day).</p>

<p>Next, let&#39;s consider hopping windows whose retention period is not a multiple
of its emission period. Say we want to output, at the top of each hour, the
orders for the previous 7,007 seconds. If we were to simulate this hopping
window using a sliding window over a tumbling window, as before, we would have
to sum lots of 1-second windows (because 3,600 and 7,007 are co-prime).
This is a lot of effort for both the system and the person writing the query.</p>

<p>Calcite could perhaps solve this generalizing <code>GROUP BY</code> syntax, but we would
be destroying the principle that an input row into a <code>GROUP BY</code> appears in
precisely one output row.</p>

<p>Calcite&#39;s SQL extensions for streaming queries are evolving. As we learn more
about how people wish to query streams, we plan to make the language more
expressive while remaining compatible with standard SQL and consistent with
its principles, look and feel.</p>

<h2 id="sorting">Sorting</h2>

<p>The story for <code>ORDER BY</code> is similar to <code>GROUP BY</code>.
The syntax looks like regular SQL, but Calcite must be sure that it can deliver
timely results. It therefore requires a monotonic expression on the leading edge
of your <code>ORDER BY</code> key.</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">STREAM</span> <span class="n">FLOOR</span><span class="p">(</span><span class="n">rowtime</span> <span class="k">TO</span> <span class="n">hour</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rowtime</span><span class="p">,</span> <span class="n">productId</span><span class="p">,</span> <span class="n">orderId</span><span class="p">,</span> <span class="n">units</span>
<span class="k">FROM</span> <span class="n">Orders</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">FLOOR</span><span class="p">(</span><span class="n">rowtime</span> <span class="k">TO</span> <span class="n">hour</span><span class="p">)</span> <span class="k">ASC</span><span class="p">,</span> <span class="n">units</span> <span class="k">DESC</span><span class="p">;</span>

  <span class="n">rowtime</span> <span class="o">|</span> <span class="n">productId</span> <span class="o">|</span> <span class="n">orderId</span> <span class="o">|</span> <span class="n">units</span>
<span class="c1">----------+-----------+---------+-------</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">30</span> <span class="o">|</span>       <span class="mi">8</span> <span class="o">|</span>    <span class="mi">20</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">30</span> <span class="o">|</span>       <span class="mi">5</span> <span class="o">|</span>     <span class="mi">4</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">20</span> <span class="o">|</span>       <span class="mi">7</span> <span class="o">|</span>     <span class="mi">2</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>       <span class="mi">6</span> <span class="o">|</span>     <span class="mi">1</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">40</span> <span class="o">|</span>      <span class="mi">11</span> <span class="o">|</span>    <span class="mi">12</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>       <span class="mi">9</span> <span class="o">|</span>     <span class="mi">6</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>      <span class="mi">12</span> <span class="o">|</span>     <span class="mi">4</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>      <span class="mi">10</span> <span class="o">|</span>     <span class="mi">1</span>
</code></pre></div>
<p>Most queries will return results in the order that they were inserted,
because the engine is using streaming algorithms, but you should not rely on it.
For example, consider this:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">STREAM</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">Orders</span>
<span class="k">WHERE</span> <span class="n">productId</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">UNION</span> <span class="k">ALL</span>
<span class="k">SELECT</span> <span class="n">STREAM</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">Orders</span>
<span class="k">WHERE</span> <span class="n">productId</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>

  <span class="n">rowtime</span> <span class="o">|</span> <span class="n">productId</span> <span class="o">|</span> <span class="n">orderId</span> <span class="o">|</span> <span class="n">units</span>
<span class="c1">----------+-----------+---------+-------</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">05</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>       <span class="mi">6</span> <span class="o">|</span>     <span class="mi">1</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">30</span> <span class="o">|</span>       <span class="mi">5</span> <span class="o">|</span>     <span class="mi">4</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">07</span> <span class="o">|</span>        <span class="mi">30</span> <span class="o">|</span>       <span class="mi">8</span> <span class="o">|</span>    <span class="mi">20</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>       <span class="mi">9</span> <span class="o">|</span>     <span class="mi">6</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>      <span class="mi">10</span> <span class="o">|</span>     <span class="mi">1</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">11</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>      <span class="mi">12</span> <span class="o">|</span>     <span class="mi">4</span>
</code></pre></div>
<p>The rows with <code>productId</code> = 30 are apparently out of order, probably because
the <code>Orders</code> stream was partitioned on <code>productId</code> and the partitioned streams
sent their data at different times.</p>

<p>If you require a particular ordering, add an explicit <code>ORDER BY</code>:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">STREAM</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">Orders</span>
<span class="k">WHERE</span> <span class="n">productId</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">UNION</span> <span class="k">ALL</span>
<span class="k">SELECT</span> <span class="n">STREAM</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">Orders</span>
<span class="k">WHERE</span> <span class="n">productId</span> <span class="o">=</span> <span class="mi">30</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">rowtime</span><span class="p">;</span>

  <span class="n">rowtime</span> <span class="o">|</span> <span class="n">productId</span> <span class="o">|</span> <span class="n">orderId</span> <span class="o">|</span> <span class="n">units</span>
<span class="c1">----------+-----------+---------+-------</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">30</span> <span class="o">|</span>       <span class="mi">5</span> <span class="o">|</span>     <span class="mi">4</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">05</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>       <span class="mi">6</span> <span class="o">|</span>     <span class="mi">1</span>
 <span class="mi">10</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">07</span> <span class="o">|</span>        <span class="mi">30</span> <span class="o">|</span>       <span class="mi">8</span> <span class="o">|</span>    <span class="mi">20</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>       <span class="mi">9</span> <span class="o">|</span>     <span class="mi">6</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mi">00</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>      <span class="mi">10</span> <span class="o">|</span>     <span class="mi">1</span>
 <span class="mi">11</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">11</span> <span class="o">|</span>        <span class="mi">10</span> <span class="o">|</span>      <span class="mi">12</span> <span class="o">|</span>     <span class="mi">4</span>
</code></pre></div>
<p>Calcite will probably implement the <code>UNION ALL</code> by merging using <code>rowtime</code>,
which is only slightly less efficient.</p>

<p>You only need to add an <code>ORDER BY</code> to the outermost query. If you need to,
say, perform <code>GROUP BY</code> after a <code>UNION ALL</code>, Calcite will add an <code>ORDER BY</code>
implicitly, in order to make the GROUP BY algorithm possible.</p>

<h2 id="table-constructor">Table constructor</h2>

<p>The <code>VALUES</code> clause creates an inline table with a given set of rows.</p>

<p>Streaming is disallowed. The set of rows never changes, and therefore a stream
would never return any rows.</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">STREAM</span> <span class="o">*</span> <span class="k">FROM</span> <span class="p">(</span><span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;abc&#39;</span><span class="p">));</span>

<span class="n">ERROR</span><span class="p">:</span> <span class="n">Cannot</span> <span class="n">stream</span> <span class="k">VALUES</span>
</code></pre></div>
<h2 id="sliding-windows">Sliding windows</h2>

<p>Standard SQL features so-called &quot;analytic functions&quot; that can be used in the
<code>SELECT</code> clause. Unlike <code>GROUP BY</code>, these do not collapse records. For each
record that goes in, one record comes out. But the aggregate function is based
on a window of many rows.</p>

<p>Let&#39;s look at an example.</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">STREAM</span> <span class="n">rowtime</span><span class="p">,</span>
  <span class="n">productId</span><span class="p">,</span>
  <span class="n">units</span><span class="p">,</span>
  <span class="k">SUM</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">rowtime</span> <span class="n">RANGE</span> <span class="nb">INTERVAL</span> <span class="s1">&#39;1&#39;</span> <span class="n">HOUR</span> <span class="n">PRECEDING</span><span class="p">)</span> <span class="n">unitsLastHour</span>
<span class="k">FROM</span> <span class="n">Orders</span><span class="p">;</span>
</code></pre></div>
<p>The feature packs a lot of power with little effort. You can have multiple
functions in the <code>SELECT</code> clause, based on multiple window specifications.</p>

<p>The following example returns orders whose average order size over the last
10 minutes is greater than the average order size for the last week.</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">STREAM</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">STREAM</span> <span class="n">rowtime</span><span class="p">,</span>
    <span class="n">productId</span><span class="p">,</span>
    <span class="n">units</span><span class="p">,</span>
    <span class="k">AVG</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">product</span> <span class="p">(</span><span class="n">RANGE</span> <span class="nb">INTERVAL</span> <span class="s1">&#39;10&#39;</span> <span class="k">MINUTE</span> <span class="n">PRECEDING</span><span class="p">)</span> <span class="k">AS</span> <span class="n">m10</span><span class="p">,</span>
    <span class="k">AVG</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="n">OVER</span> <span class="n">product</span> <span class="p">(</span><span class="n">RANGE</span> <span class="nb">INTERVAL</span> <span class="s1">&#39;7&#39;</span> <span class="k">DAY</span> <span class="n">PRECEDING</span><span class="p">)</span> <span class="k">AS</span> <span class="n">d7</span>
  <span class="k">FROM</span> <span class="n">Orders</span>
  <span class="n">WINDOW</span> <span class="n">product</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">rowtime</span>
    <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">productId</span><span class="p">))</span>
<span class="k">WHERE</span> <span class="n">m10</span> <span class="o">&gt;</span> <span class="n">d7</span><span class="p">;</span>
</code></pre></div>
<p>For conciseness, here we use a syntax where you partially define a window
using a <code>WINDOW</code> clause and then refine the window in each <code>OVER</code> clause.
You could also define all windows in the <code>WINDOW</code> clause, or all windows inline,
if you wish.</p>

<p>But the real power goes beyond syntax. Behind the scenes, this query is
maintaining two tables, and adding and removing values from sub-totals using
with FIFO queues. But you can access those tables without introducing a join
into the query.</p>

<p>Some other features of the windowed aggregation syntax:
* You can define windows based on row count.
* The window can reference rows that have not yet arrived.
  (The stream will wait until they have arrived).
* You can compute order-dependent functions such as <code>RANK</code> and median.</p>

<h2 id="cascading-windows">Cascading windows</h2>

<p>What if we want a query that returns a result for every record, like a
sliding window, but resets totals on a fixed time period, like a
tumbling window? Such a pattern is called a <em>cascading window</em>. Here
is an example:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">STREAM</span> <span class="n">rowtime</span><span class="p">,</span>
  <span class="n">productId</span><span class="p">,</span>
  <span class="n">units</span><span class="p">,</span>
  <span class="k">SUM</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">FLOOR</span><span class="p">(</span><span class="n">rowtime</span> <span class="k">TO</span> <span class="n">HOUR</span><span class="p">))</span> <span class="k">AS</span> <span class="n">unitsSinceTopOfHour</span>
<span class="k">FROM</span> <span class="n">Orders</span><span class="p">;</span>
</code></pre></div>
<p>It looks similar to a sliding window query, but the monotonic
expression occurs within the <code>PARTITION BY</code> clause of the window. As
the rowtime moves from from 10:59:59 to 11:00:00, <code>FLOOR(rowtime TO
HOUR)</code> changes from 10:00:00 to 11:00:00, and therefore a new
partition starts. The first row to arrive in the new hour will start a
new total; the second row will have a total that consists of two rows,
and so on.</p>

<p>Calcite knows that the old partition will never be used again, so
removes all sub-totals for that partition from its internal storage.</p>

<p>Analytic functions that using cascading and sliding windows can be
combined in the same query.</p>

<h2 id="state-of-the-stream">State of the stream</h2>

<p>Not all concepts in this article have been implemented in Calcite.
And others may be implemented in Calcite but not in a particular adapter
such as Samza SQL [<a href="#ref3">3</a>].</p>

<h3 id="implemented">Implemented</h3>

<ul>
<li>Streaming SELECT, WHERE, GROUP BY, HAVING, UNION ALL, ORDER BY</li>
<li>FLOOR and CEILING functions</li>
<li>Monotonicity</li>
<li>Streaming VALUES is disallowed</li>
</ul>

<h3 id="not-implemented">Not implemented</h3>

<ul>
<li>Stream-to-stream JOIN</li>
<li>Stream-to-table JOIN</li>
<li>Stream on view</li>
<li>Streaming UNION ALL with ORDER BY (merge)</li>
<li>Relational query on stream</li>
<li>Streaming windowed aggregation (sliding and cascading windows)</li>
<li>Check that STREAM in sub-queries and views is ignored</li>
<li>Check that streaming ORDER BY cannot have OFFSET or LIMIT</li>
<li>Limited history; at run time, check that there is sufficient history
to run the query.</li>
</ul>

<h3 id="to-do-in-this-document">To do in this document</h3>

<ul>
<li>Re-visit whether you can stream VALUES</li>
<li>OVER clause to define window on stream</li>
<li>Windowed aggregation</li>
<li>Punctuation</li>
<li>Stream-to-table join
** Stream-to-table join where table is changing</li>
<li>Stream-to-stream join</li>
<li>Relational queries on streams (e.g. &quot;pie chart&quot; query)</li>
<li>Diagrams for various window types</li>
</ul>

<h2 id="references">References</h2>

<ul>
<li>[<a name="ref1">1</a>]
<a href="http://ilpubs.stanford.edu:8090/758/">Arasu, Arvind and Babu,
Shivnath and Widom, Jennifer (2003) The CQL Continuous Query
Language: Semantic Foundations and Query Execution</a>.</li>
<li>[<a name="ref2">2</a>]
<a href="http://kafka.apache.org/documentation.html">Apache Kafka</a>.</li>
<li>[<a name="ref3">3</a>] <a href="http://samza.apache.org">Apache Samza</a>.</li>
</ul>


                    </div>
                
            </div>

            

            <div class=row-fluid>
                <div id=footer class=span12>
                    Copyright © 2014  <a href="http://www.apache.org">Apache Software Foundation</a>. All Rights Reserved. 

                </div>
            </div>
        </div>

        <script>
            function orderNav() {
                var list,
                    section,
                    header,
                    sections = [],
                    lists = {},
                    headers = {};

                var navUl = document.querySelectorAll('#navigation ul')[0],
                    navLis = document.querySelectorAll('#navigation ul li');

                if (!navUl) return;

                for (var i = 0; i < navLis.length; i++) {
                    var order, li = navLis[i];

                    if (li.classList.contains('nav-header')) {
                        section = li.textContent || li.innerText;
                        sections.push(section);
                        headers[section] = li;
                        continue;
                    }

                    if (!lists[section]) {
                        lists[section] = [];
                    }

                    order = parseFloat(li.getAttribute('data-order'))
                    lists[section].push([order, li]);
                }

                for (var i = 0; i < sections.length; i++) {
                    section = sections[i];
                    list = lists[section].sort(function(a, b) {
                        return a[0] - b[0];
                    });

                    if (header = headers[section]) {
                        navUl.appendChild(header);
                    }
                    for (var j = 0; j < list.length; j++) {
                        navUl.appendChild(list[j][1]);
                    }
                }
            }

            if (document.querySelectorAll) orderNav();
        </script>
        
    </body>
</html>
