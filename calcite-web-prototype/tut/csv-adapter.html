<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>Apache Calcite : CSV Adapter</title>
        <meta name="description" content="A Dynamic Data Management Framework">
        <!-- jQuery -->
        <script type="text/javascript" src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,600italic,700italic,400,600,700' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:300,400,500,600,700' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="http://milinda.pathirage.org/calcite-web-prototype//css/syntax.css">
        <link rel="stylesheet" href="http://milinda.pathirage.org/calcite-web-prototype//css/main.css">
    </head>
    <body>
      <nav class="navbar navbar-default navbar-static-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://milinda.pathirage.org/calcite-web-prototype//"><img src="http://milinda.pathirage.org/calcite-web-prototype//images/calcite-logo.png"/>Apache Calcite</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Apache <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li><a href="#">How Apache Works</a></li>
                <li><a href="#">Foundation</a></li>
                <li><a href="#">Sponsoring Apache</a></li>
                <li><a href="#">Thanks</a></li>
              </ul>
            </li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>


        <div class="container main-container">
            <div class=row-fluid>
                
                
                    <div id=navigation class=col-sm-3>
                        <ul class="nav nav-list sd-nav">
    
        
        

        
            
                <li class=nav-header>Project</li>
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//proj/incubator-proposal.html">Incubator Proposal</a></li>
        
    
        
        

        
    
        
        

        
            
                <li class=nav-header>Tutorials</li>
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//tut/csv-adapter.html">CSV Adapter</a></li>
        
    
        
        

        
            
                <li class=nav-header>Reference</li>
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//ref/sql-extensions-for-streaming.html">SQL Extensions for Streaming</a></li>
        
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//ref/sql-language-reference.html">SQL Language Reference</a></li>
        
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//ref/json-model.html">JSON Model</a></li>
        
    
        
        

        
            
                <li class=nav-header>Community</li>
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//com/source-repository.html">Source Repository</a></li>
        
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//com/committers.html">Committers</a></li>
        
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//com/bugs.html">Bugs</a></li>
        
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//com/mailing-lists.html">Mailing Lists</a></li>
        
    
        
        

        
    
        
        

        
            
                <li class=nav-header>Downloads</li>
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//down/092incubating.html">0.9.2-incubating</a></li>
        
            
            <li data-order=""><a href="http://milinda.pathirage.org/calcite-web-prototype//down/091incubating.html">0.9.1-incubating</a></li>
        
    
<!-- List additional links. It is recommended to add a divider
    e.g. <li class=divider></li> first to break up the content. -->
</ul>

                    </div>

                    <div id=content class=col-sm-9>
                        <div class=page-header>
    <h2>CSV Adapter
        
    </h2>
</div>

<p>Calcite-example-CSV is a fully functional adapter for
<a href="https://github.com/apache/incubator-calcite">Calcite</a> that reads
text files in
<a href="http://en.wikipedia.org/wiki/Comma-separated_values">CSV
(comma-separated values)</a> format. It is remarkable that a couple of
hundred lines of Java code are sufficient to provide full SQL query
capability.</p>

<p>CSV also serves as a template for building adapters to other
data formats. Even though there are not many lines of code, it covers
several important concepts:</p>

<ul>
<li>user-defined schema using SchemaFactory and Schema interfaces;</li>
<li>declaring schemas in a model JSON file;</li>
<li>declaring views in a model JSON file;</li>
<li>user-defined table using the Table interface;</li>
<li>determining the record type of a table;</li>
<li>a simple implementation of Table, using the ScannableTable interface, that
enumerates all rows directly;</li>
<li>a more advanced implementation that implements FilterableTable, and can
filter out rows according to simple predicates;</li>
<li>advanced implementation of Table, using TranslatableTable, that translates
to relational operators using planner rules.</li>
</ul>

<h2 id="download-and-build">Download and build</h2>

<p>You need Java (1.6 or higher; 1.7 preferred), git and maven (3.0.4 or later).</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>git clone https://github.com/apache/incubator-calcite.git
<span class="nv">$ </span><span class="nb">cd </span>incubator-calcite
<span class="nv">$ </span>mvn install -DskipTests -Dcheckstyle.skip<span class="o">=</span><span class="nb">true</span>
<span class="nv">$ </span><span class="nb">cd </span>example/csv
</code></pre></div>
<h2 id="first-queries">First queries</h2>

<p>Now let&#39;s connect to Calcite using
<a href="https://github.com/julianhyde/sqlline">sqlline</a>, a SQL shell
that is included in this project.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>./sqlline
sqlline&gt; !connect jdbc:calcite:model<span class="o">=</span>target/test-classes/model.json admin admin
</code></pre></div>
<p>(If you are running Windows, the command is <code>sqlline.bat</code>.)</p>

<p>Execute a metadata query:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">sqlline&gt; !tables
+------------+--------------+-------------+---------------+----------+------+
<span class="p">|</span> TABLE_CAT  <span class="p">|</span> TABLE_SCHEM  <span class="p">|</span> TABLE_NAME  <span class="p">|</span>  TABLE_TYPE   <span class="p">|</span> REMARKS  <span class="p">|</span> TYPE <span class="p">|</span>
+------------+--------------+-------------+---------------+----------+------+
<span class="p">|</span> null       <span class="p">|</span> SALES        <span class="p">|</span> DEPTS       <span class="p">|</span> TABLE         <span class="p">|</span> null     <span class="p">|</span> null <span class="p">|</span>
<span class="p">|</span> null       <span class="p">|</span> SALES        <span class="p">|</span> EMPS        <span class="p">|</span> TABLE         <span class="p">|</span> null     <span class="p">|</span> null <span class="p">|</span>
<span class="p">|</span> null       <span class="p">|</span> SALES        <span class="p">|</span> HOBBIES     <span class="p">|</span> TABLE         <span class="p">|</span> null     <span class="p">|</span> null <span class="p">|</span>
<span class="p">|</span> null       <span class="p">|</span> metadata     <span class="p">|</span> COLUMNS     <span class="p">|</span> SYSTEM_TABLE  <span class="p">|</span> null     <span class="p">|</span> null <span class="p">|</span>
<span class="p">|</span> null       <span class="p">|</span> metadata     <span class="p">|</span> TABLES      <span class="p">|</span> SYSTEM_TABLE  <span class="p">|</span> null     <span class="p">|</span> null <span class="p">|</span>
+------------+--------------+-------------+---------------+----------+------+
</code></pre></div>
<p>(JDBC experts, note: sqlline&#39;s <code>!tables</code> command is just executing
<a href="http://docs.oracle.com/javase/7/docs/api/java/sql/DatabaseMetaData.html#getTables(java.lang.String, java.lang.String, java.lang.String, java.lang.String[])"><code>DatabaseMetaData.getTables()</code></a>
behind the scenes.
It has other commands to query JDBC metadata, such as <code>!columns</code> and <code>!describe</code>.)</p>

<p>As you can see there are 5 tables in the system: tables
<code>EMPS</code>, <code>DEPTS</code> and <code>HOBBIES</code> in the current
<code>SALES</code> schema, and <code>COLUMNS</code> and
<code>TABLES</code> in the system <code>metadata</code> schema. The
system tables are always present in Calcite, but the other tables are
provided by the specific implementation of the schema; in this case,
the <code>EMPS</code> and <code>DEPTS</code> tables are based on the
<code>EMPS.csv</code> and <code>DEPTS.csv</code> files in the
<code>target/test-classes</code> directory.</p>

<p>Let&#39;s execute some queries on those tables, to show that Calcite is providing
a full implementation of SQL. First, a table scan:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">sqlline&gt; SELECT * FROM emps<span class="p">;</span>
+--------+--------+---------+---------+----------------+--------+-------+---+
<span class="p">|</span> EMPNO  <span class="p">|</span>  NAME  <span class="p">|</span> DEPTNO  <span class="p">|</span> GENDER  <span class="p">|</span>      CITY      <span class="p">|</span> EMPID  <span class="p">|</span>  AGE  <span class="p">|</span> S <span class="p">|</span>
+--------+--------+---------+---------+----------------+--------+-------+---+
<span class="p">|</span> <span class="m">100</span>    <span class="p">|</span> Fred   <span class="p">|</span> <span class="m">10</span>      <span class="p">|</span>         <span class="p">|</span>                <span class="p">|</span> <span class="m">30</span>     <span class="p">|</span> <span class="m">25</span>    <span class="p">|</span> t <span class="p">|</span>
<span class="p">|</span> <span class="m">110</span>    <span class="p">|</span> Eric   <span class="p">|</span> <span class="m">20</span>      <span class="p">|</span> M       <span class="p">|</span> San Francisco  <span class="p">|</span> <span class="m">3</span>      <span class="p">|</span> <span class="m">80</span>    <span class="p">|</span> n <span class="p">|</span>
<span class="p">|</span> <span class="m">110</span>    <span class="p">|</span> John   <span class="p">|</span> <span class="m">40</span>      <span class="p">|</span> M       <span class="p">|</span> Vancouver      <span class="p">|</span> <span class="m">2</span>      <span class="p">|</span> null  <span class="p">|</span> f <span class="p">|</span>
<span class="p">|</span> <span class="m">120</span>    <span class="p">|</span> Wilma  <span class="p">|</span> <span class="m">20</span>      <span class="p">|</span> F       <span class="p">|</span>                <span class="p">|</span> <span class="m">1</span>      <span class="p">|</span> <span class="m">5</span>     <span class="p">|</span> n <span class="p">|</span>
<span class="p">|</span> <span class="m">130</span>    <span class="p">|</span> Alice  <span class="p">|</span> <span class="m">40</span>      <span class="p">|</span> F       <span class="p">|</span> Vancouver      <span class="p">|</span> <span class="m">2</span>      <span class="p">|</span> null  <span class="p">|</span> f <span class="p">|</span>
+--------+--------+---------+---------+----------------+--------+-------+---+
</code></pre></div>
<p>Now JOIN and GROUP BY:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">sqlline&gt; SELECT d.name, COUNT<span class="o">(</span>*<span class="o">)</span>
. . . .&gt; FROM emps AS e JOIN depts AS d ON e.deptno <span class="o">=</span> d.deptno
. . . .&gt; GROUP BY d.name<span class="p">;</span>
+------------+---------+
<span class="p">|</span>    NAME    <span class="p">|</span> EXPR<span class="nv">$1</span>  <span class="p">|</span>
+------------+---------+
<span class="p">|</span> Sales      <span class="p">|</span> <span class="m">1</span>       <span class="p">|</span>
<span class="p">|</span> Marketing  <span class="p">|</span> <span class="m">2</span>       <span class="p">|</span>
+------------+---------+
</code></pre></div>
<p>Last, the VALUES operator generates a single row, and is a convenient
way to test expressions and SQL built-in functions:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">sqlline&gt; VALUES CHAR_LENGTH<span class="o">(</span><span class="s1">&#39;Hello, &#39;</span> <span class="o">||</span> <span class="s1">&#39;world!&#39;</span><span class="o">)</span><span class="p">;</span>
+---------+
<span class="p">|</span> EXPR<span class="nv">$0</span>  <span class="p">|</span>
+---------+
<span class="p">|</span> <span class="m">13</span>      <span class="p">|</span>
+---------+
</code></pre></div>
<p>Calcite has many other SQL features. We don&#39;t have time to cover them
here. Write some more queries to experiment.</p>

<h2 id="schema-discovery">Schema discovery</h2>

<p>Now, how did Calcite find these tables? Remember, core Calcite does not
know anything about CSV files. (As a &quot;database without a storage
layer&quot;, Calcite doesn&#39;t know about any file formats.) Calcite knows about
those tables because we told it to run code in the calcite-example-csv
project.</p>

<p>There are a couple of steps in that chain. First, we define a schema
based on a schema factory class in a model file. Then the schema
factory creates a schema, and the schema creates several tables, each
of which knows how to get data by scanning a CSV file. Last, after
Calcite has parsed the query and planned it to use those tables, Calcite
invokes the tables to read the data as the query is being
executed. Now let&#39;s look at those steps in more detail.</p>

<p>On the JDBC connect string we gave the path of a model in JSON
format. Here is the model:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="err">version:</span> <span class="err">&#39;1.0&#39;,</span>
  <span class="err">defaultSchema:</span> <span class="err">&#39;SALES&#39;,</span>
  <span class="err">schemas:</span> <span class="err">[</span>
    <span class="err">{</span>
      <span class="err">name:</span> <span class="err">&#39;SALES&#39;,</span>
      <span class="err">type:</span> <span class="err">&#39;custom&#39;,</span>
      <span class="err">factory:</span> <span class="err">&#39;org.apache.calcite.adapter.csv.CsvSchemaFactory&#39;,</span>
      <span class="err">operand:</span> <span class="err">{</span>
        <span class="err">directory:</span> <span class="err">&#39;target/test-classes/sales&#39;</span>
      <span class="p">}</span>
    <span class="err">}</span>
  <span class="err">]</span>
<span class="err">}</span>
</code></pre></div>
<p>The model defines a single schema called &#39;SALES&#39;. The schema is
powered by a plugin class,
<a href="../example/csv/src/main/java/org/apache/calcite/adapter/csv/CsvSchemaFactory.java">org.apache.calcite.adapter.csv.CsvSchemaFactory</a>,
which is part of the
calcite-example-csv project and implements the Calcite interface
<a href="http://www.hydromatic.net/calcite/apidocs/org/apache/calcite/schema/SchemaFactory.html">SchemaFactory</a>.
Its <code>create</code> method instantiates a
schema, passing in the <code>directory</code> argument from the model file:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">Schema</span> <span class="nf">create</span><span class="o">(</span><span class="n">SchemaPlus</span> <span class="n">parentSchema</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">operand</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">String</span> <span class="n">directory</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">operand</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;directory&quot;</span><span class="o">);</span>
  <span class="n">String</span> <span class="n">flavorName</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">operand</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;flavor&quot;</span><span class="o">);</span>
  <span class="n">CsvTable</span><span class="o">.</span><span class="na">Flavor</span> <span class="n">flavor</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">flavorName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">flavor</span> <span class="o">=</span> <span class="n">CsvTable</span><span class="o">.</span><span class="na">Flavor</span><span class="o">.</span><span class="na">SCANNABLE</span><span class="o">;</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">flavor</span> <span class="o">=</span> <span class="n">CsvTable</span><span class="o">.</span><span class="na">Flavor</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">flavorName</span><span class="o">.</span><span class="na">toUpperCase</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nf">CsvSchema</span><span class="o">(</span>
      <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">directory</span><span class="o">),</span>
      <span class="n">flavor</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>Driven by the model, the schema factory instantiates a single schema
called &#39;SALES&#39;.  The schema is an instance of
<a href="../example/csv/src/main/java/org/apache/calcite/adapter/csv/CsvSchema.java">org.apache.calcite.adapter.csv.CsvSchema</a>
and implements the Calcite interface <a
href="http://www.hydromatic.net/calcite/apidocs/org/apache/calcite/schema/Schema.html">Schema</a>.</p>

<p>A schema&#39;s job is to produce a list of tables. (It can also list sub-schemas and
table-functions, but these are advanced features and calcite-example-csv does
not support them.) The tables implement Calcite&#39;s
<a href="http://www.hydromatic.net/calcite/apidocs/org/apache/calcite/schema/Table.html">Table</a>
interface. <code>CsvSchema</code> produces tables that are instances of
<a href="../example/csv/src/main/java/org/apache/calcite/adapter/csv/CsvTable.java">CsvTable</a>
and its sub-classes.</p>

<p>Here is the relevant code from <code>CsvSchema</code>, overriding the
<code><a href="http://www.hydromatic.net/calcite/apidocs/org/apache/calcite/schema/impl/AbstractSchema.html#getTableMap()">getTableMap()</a></code>
method in the <code>AbstractSchema</code> base class.</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Table</span><span class="o">&gt;</span> <span class="nf">getTableMap</span><span class="o">()</span> <span class="o">{</span>
  <span class="c1">// Look for files in the directory ending in &quot;.csv&quot;, &quot;.csv.gz&quot;, &quot;.json&quot;,</span>
  <span class="c1">// &quot;.json.gz&quot;.</span>
  <span class="n">File</span><span class="o">[]</span> <span class="n">files</span> <span class="o">=</span> <span class="n">directoryFile</span><span class="o">.</span><span class="na">listFiles</span><span class="o">(</span>
      <span class="k">new</span> <span class="nf">FilenameFilter</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">File</span> <span class="n">dir</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
          <span class="kd">final</span> <span class="n">String</span> <span class="n">nameSansGz</span> <span class="o">=</span> <span class="n">trim</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="s">&quot;.gz&quot;</span><span class="o">);</span>
          <span class="k">return</span> <span class="n">nameSansGz</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&quot;.csv&quot;</span><span class="o">)</span>
              <span class="o">||</span> <span class="n">nameSansGz</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&quot;.json&quot;</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">});</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">files</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;directory &quot;</span> <span class="o">+</span> <span class="n">directoryFile</span> <span class="o">+</span> <span class="s">&quot; not found&quot;</span><span class="o">);</span>
    <span class="n">files</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
  <span class="o">}</span>
  <span class="c1">// Build a map from table name to table; each file becomes a table.</span>
  <span class="kd">final</span> <span class="n">ImmutableMap</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Table</span><span class="o">&gt;</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">ImmutableMap</span><span class="o">.</span><span class="na">builder</span><span class="o">();</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">File</span> <span class="n">file</span> <span class="o">:</span> <span class="n">files</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">tableName</span> <span class="o">=</span> <span class="n">trim</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="s">&quot;.gz&quot;</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">tableNameSansJson</span> <span class="o">=</span> <span class="n">trimOrNull</span><span class="o">(</span><span class="n">tableName</span><span class="o">,</span> <span class="s">&quot;.json&quot;</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">tableNameSansJson</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">JsonTable</span> <span class="n">table</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">JsonTable</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
      <span class="n">builder</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">tableNameSansJson</span><span class="o">,</span> <span class="n">table</span><span class="o">);</span>
      <span class="k">continue</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">tableName</span> <span class="o">=</span> <span class="n">trim</span><span class="o">(</span><span class="n">tableName</span><span class="o">,</span> <span class="s">&quot;.csv&quot;</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">Table</span> <span class="n">table</span> <span class="o">=</span> <span class="n">createTable</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">tableName</span><span class="o">,</span> <span class="n">table</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>

<span class="cm">/** Creates different sub-type of table based on the &quot;flavor&quot; attribute. */</span>
<span class="kd">private</span> <span class="n">Table</span> <span class="nf">createTable</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">switch</span> <span class="o">(</span><span class="n">flavor</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nl">TRANSLATABLE:</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">CsvTranslatableTable</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
  <span class="k">case</span> <span class="nl">SCANNABLE:</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">CsvScannableTable</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
  <span class="k">case</span> <span class="nl">FILTERABLE:</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">CsvFilterableTable</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
  <span class="k">default</span><span class="o">:</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">AssertionError</span><span class="o">(</span><span class="s">&quot;Unknown flavor &quot;</span> <span class="o">+</span> <span class="n">flavor</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>The schema scans the directory and finds all files whose name ends
with &quot;.csv&quot; and creates tables for them. In this case, the directory
is <code>target/test-classes/sales</code> and contains files
<code>EMPS.csv</code> and <code>DEPTS.csv</code>, which these become
the tables <code>EMPS</code> and <code>DEPTS</code>.</p>

<h2 id="tables-and-views-in-schemas">Tables and views in schemas</h2>

<p>Note how we did not need to define any tables in the model; the schema
generated the tables automatically.</p>

<p>You can define extra tables,
beyond those that are created automatically,
using the <code>tables</code> property of a schema.</p>

<p>Let&#39;s see how to create
an important and useful type of table, namely a view.</p>

<p>A view looks like a table when you are writing a query, but it doesn&#39;t store data.
It derives its result by executing a query.
The view is expanded while the query is being planned, so the query planner
can often perform optimizations like removing expressions from the SELECT
clause that are not used in the final result.</p>

<p>Here is a schema that defines a view:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="err">version:</span> <span class="err">&#39;1.0&#39;,</span>
  <span class="err">defaultSchema:</span> <span class="err">&#39;SALES&#39;,</span>
  <span class="err">schemas:</span> <span class="err">[</span>
    <span class="err">{</span>
      <span class="err">name:</span> <span class="err">&#39;SALES&#39;,</span>
      <span class="err">type:</span> <span class="err">&#39;custom&#39;,</span>
      <span class="err">factory:</span> <span class="err">&#39;org.apache.calcite.adapter.csv.CsvSchemaFactory&#39;,</span>
      <span class="err">operand:</span> <span class="err">{</span>
        <span class="err">directory:</span> <span class="err">&#39;target/test-classes/sales&#39;</span>
      <span class="p">}</span><span class="err">,</span>
      <span class="err">tables:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="err">name:</span> <span class="err">&#39;FEMALE_EMPS&#39;,</span>
          <span class="err">type:</span> <span class="err">&#39;view&#39;,</span>
          <span class="err">sql:</span> <span class="err">&#39;SELECT</span> <span class="err">*</span> <span class="err">FROM</span> <span class="err">emps</span> <span class="err">WHERE</span> <span class="err">gender</span> <span class="err">=</span> <span class="err">\&#39;F\&#39;&#39;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="err">}</span>
  <span class="err">]</span>
<span class="err">}</span>
</code></pre></div>
<p>The line <code>type: &#39;view&#39;</code> tags <code>FEMALE_EMPS</code> as a view,
as opposed to a regular table or a custom table.
Note that single-quotes within the view definition are escaped using a
back-slash, in the normal way for JSON.</p>

<p>JSON doesn&#39;t make it easy to author long strings, so Calcite supports an
alternative syntax. If your view has a long SQL statement, you can instead
supply a list of lines rather than a single string:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json">        <span class="p">{</span>
          <span class="err">name:</span> <span class="err">&#39;FEMALE_EMPS&#39;,</span>
          <span class="err">type:</span> <span class="err">&#39;view&#39;,</span>
          <span class="err">sql:</span> <span class="err">[</span>
            <span class="err">&#39;SELECT</span> <span class="err">*</span> <span class="err">FROM</span> <span class="err">emps&#39;,</span>
            <span class="err">&#39;WHERE</span> <span class="err">gender</span> <span class="err">=</span> <span class="err">\&#39;F\&#39;&#39;</span>
          <span class="err">]</span>
        <span class="p">}</span>
</code></pre></div>
<p>Now we have defined a view, we can use it in queries just as if it were a table:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">sqlline</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">e</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="p">.</span><span class="n">name</span> <span class="k">FROM</span> <span class="n">female_emps</span> <span class="k">AS</span> <span class="n">e</span> <span class="k">JOIN</span> <span class="n">depts</span> <span class="k">AS</span> <span class="n">d</span> <span class="k">on</span> <span class="n">e</span><span class="p">.</span><span class="n">deptno</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">deptno</span><span class="p">;</span>
<span class="o">+</span><span class="c1">--------+------------+</span>
<span class="o">|</span>  <span class="n">NAME</span>  <span class="o">|</span>    <span class="n">NAME</span>    <span class="o">|</span>
<span class="o">+</span><span class="c1">--------+------------+</span>
<span class="o">|</span> <span class="n">Wilma</span>  <span class="o">|</span> <span class="n">Marketing</span>  <span class="o">|</span>
<span class="o">+</span><span class="c1">--------+------------+</span>
</code></pre></div>
<h2 id="custom-tables">Custom tables</h2>

<p>Custom tables are tables whose implementation is driven by user-defined code.
They don&#39;t need to live in a custom schema.</p>

<p>There is an example in <code>model-with-custom-table.json</code>:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="err">version:</span> <span class="err">&#39;1.0&#39;,</span>
  <span class="err">defaultSchema:</span> <span class="err">&#39;CUSTOM_TABLE&#39;,</span>
  <span class="err">schemas:</span> <span class="err">[</span>
    <span class="err">{</span>
      <span class="err">name:</span> <span class="err">&#39;CUSTOM_TABLE&#39;,</span>
      <span class="err">tables:</span> <span class="err">[</span>
        <span class="err">{</span>
          <span class="err">name:</span> <span class="err">&#39;EMPS&#39;,</span>
          <span class="err">type:</span> <span class="err">&#39;custom&#39;,</span>
          <span class="err">factory:</span> <span class="err">&#39;org.apache.calcite.adapter.csv.CsvTableFactory&#39;,</span>
          <span class="err">operand:</span> <span class="err">{</span>
            <span class="err">file:</span> <span class="err">&#39;target/test-classes/sales/EMPS.csv.gz&#39;,</span>
            <span class="err">flavor:</span> <span class="nt">&quot;scannable&quot;</span>
          <span class="p">}</span>
        <span class="err">}</span>
      <span class="err">]</span>
    <span class="err">}</span>
  <span class="err">]</span>
<span class="err">}</span>
</code></pre></div>
<p>We can query the table in the usual way:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">sqlline</span><span class="o">&gt;</span> <span class="o">!</span><span class="k">connect</span> <span class="n">jdbc</span><span class="p">:</span><span class="n">calcite</span><span class="p">:</span><span class="n">model</span><span class="o">=</span><span class="n">target</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">classes</span><span class="o">/</span><span class="n">model</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="k">table</span><span class="p">.</span><span class="n">json</span> <span class="k">admin</span> <span class="k">admin</span>
<span class="n">sqlline</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">empno</span><span class="p">,</span> <span class="n">name</span> <span class="k">FROM</span> <span class="n">custom_table</span><span class="p">.</span><span class="n">emps</span><span class="p">;</span>
<span class="o">+</span><span class="c1">--------+--------+</span>
<span class="o">|</span> <span class="n">EMPNO</span>  <span class="o">|</span>  <span class="n">NAME</span>  <span class="o">|</span>
<span class="o">+</span><span class="c1">--------+--------+</span>
<span class="o">|</span> <span class="mi">100</span>    <span class="o">|</span> <span class="n">Fred</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">110</span>    <span class="o">|</span> <span class="n">Eric</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">110</span>    <span class="o">|</span> <span class="n">John</span>   <span class="o">|</span>
<span class="o">|</span> <span class="mi">120</span>    <span class="o">|</span> <span class="n">Wilma</span>  <span class="o">|</span>
<span class="o">|</span> <span class="mi">130</span>    <span class="o">|</span> <span class="n">Alice</span>  <span class="o">|</span>
<span class="o">+</span><span class="c1">--------+--------+</span>
</code></pre></div>
<p>The schema is a regular one, and contains a custom table powered by
<a href="../example/csv/src/main/java/org/apache/calcite/adapter/csv/CsvTableFactory.java">org.apache.calcite.adapter.csv.CsvTableFactory</a>,
which implements the Calcite interface
<a href="http://www.hydromatic.net/calcite/apidocs/org/apache/calcite/schema/TableFactory.html">TableFactory</a>.
Its <code>create</code> method instantiates a <code>CsvScannableTable</code>,
passing in the <code>file</code> argument from the model file:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">CsvTable</span> <span class="nf">create</span><span class="o">(</span><span class="n">SchemaPlus</span> <span class="n">schema</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">,</span> <span class="n">RelDataType</span> <span class="n">rowType</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;file&quot;</span><span class="o">);</span>
  <span class="kd">final</span> <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">fileName</span><span class="o">);</span>
  <span class="kd">final</span> <span class="n">RelProtoDataType</span> <span class="n">protoRowType</span> <span class="o">=</span>
      <span class="n">rowType</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">RelDataTypeImpl</span><span class="o">.</span><span class="na">proto</span><span class="o">(</span><span class="n">rowType</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nf">CsvScannableTable</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">protoRowType</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>Implementing a custom table is often a simpler alternative to implementing
a custom schema. Both approaches might end up creating a similar implementation
of the <code>Table</code> interface, but for the custom table you don&#39;t
need to implement metadata discovery. (<code>CsvTableFactory</code>
creates a <code>CsvScannableTable</code>, just as <code>CsvSchema</code> does,
but the table implementation does not scan the filesystem for .csv files.)</p>

<p>Custom tables require more work for the author of the model (the author
needs to specify each table and its file explicitly) but also give the author
more control (say, providing different parameters for each table).</p>

<h2 id="comments-in-models">Comments in models</h2>

<p>Models can include comments using <code>/* ... */</code> and <code>//</code> syntax:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="err">version:</span> <span class="err">&#39;1.0&#39;,</span>
  <span class="err">/*</span> <span class="err">Multi-line</span>
     <span class="err">comment.</span> <span class="err">*/</span>
  <span class="err">defaultSchema:</span> <span class="err">&#39;CUSTOM_TABLE&#39;,</span>
  <span class="err">//</span> <span class="err">Single-line</span> <span class="err">comment.</span>
  <span class="err">schemas:</span> <span class="err">[</span>
    <span class="err">..</span>
  <span class="err">]</span>
<span class="p">}</span>
</code></pre></div>
<p>(Comments are not standard JSON, but are a harmless extension.)</p>

<h2 id="optimizing-queries-using-planner-rules">Optimizing queries using planner rules</h2>

<p>The table implementations we have seen so far are fine as long as the tables
don&#39;t contain a great deal of data. But if your customer table has, say, a
hundred columns and a million rows, you would rather that the system did not
retrieve all of the data for every query. You would like Calcite to negotiate
with the adapter and find a more efficient way of accessing the data.</p>

<p>This negotiation is a simple form of query optimization. Calcite supports query
optimization by adding <i>planner rules</i>. Planner rules operate by
looking for patterns in the query parse tree (for instance a project on top
of a certain kind of table), and</p>

<p>Planner rules are also extensible, like schemas and tables. So, if you have a
data store that you want to access via SQL, you first define a custom table or
schema, and then you define some rules to make the access efficient.</p>

<p>To see this in action, let&#39;s use a planner rule to access
a subset of columns from a CSV file. Let&#39;s run the same query against two very
similar schemas:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">sqlline</span><span class="o">&gt;</span> <span class="o">!</span><span class="k">connect</span> <span class="n">jdbc</span><span class="p">:</span><span class="n">calcite</span><span class="p">:</span><span class="n">model</span><span class="o">=</span><span class="n">target</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">classes</span><span class="o">/</span><span class="n">model</span><span class="p">.</span><span class="n">json</span> <span class="k">admin</span> <span class="k">admin</span>
<span class="n">sqlline</span><span class="o">&gt;</span> <span class="k">explain</span> <span class="n">plan</span> <span class="k">for</span> <span class="k">select</span> <span class="n">name</span> <span class="k">from</span> <span class="n">emps</span><span class="p">;</span>
<span class="o">+</span><span class="c1">-----------------------------------------------------+</span>
<span class="o">|</span> <span class="n">PLAN</span>                                                <span class="o">|</span>
<span class="o">+</span><span class="c1">-----------------------------------------------------+</span>
<span class="o">|</span> <span class="n">EnumerableCalcRel</span><span class="p">(</span><span class="n">expr</span><span class="o">#</span><span class="mi">0</span><span class="p">..</span><span class="mi">9</span><span class="o">=</span><span class="p">[</span><span class="err">{</span><span class="n">inputs</span><span class="err">}</span><span class="p">],</span> <span class="n">NAME</span><span class="o">=</span><span class="p">[</span><span class="err">$</span><span class="n">t1</span><span class="p">])</span> <span class="o">|</span>
<span class="o">|</span>   <span class="n">EnumerableTableAccessRel</span><span class="p">(</span><span class="k">table</span><span class="o">=</span><span class="p">[[</span><span class="n">SALES</span><span class="p">,</span> <span class="n">EMPS</span><span class="p">]])</span>   <span class="o">|</span>
<span class="o">+</span><span class="c1">-----------------------------------------------------+</span>
<span class="n">sqlline</span><span class="o">&gt;</span> <span class="o">!</span><span class="k">connect</span> <span class="n">jdbc</span><span class="p">:</span><span class="n">calcite</span><span class="p">:</span><span class="n">model</span><span class="o">=</span><span class="n">target</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">classes</span><span class="o">/</span><span class="n">smart</span><span class="p">.</span><span class="n">json</span> <span class="k">admin</span> <span class="k">admin</span>
<span class="n">sqlline</span><span class="o">&gt;</span> <span class="k">explain</span> <span class="n">plan</span> <span class="k">for</span> <span class="k">select</span> <span class="n">name</span> <span class="k">from</span> <span class="n">emps</span><span class="p">;</span>
<span class="o">+</span><span class="c1">-----------------------------------------------------+</span>
<span class="o">|</span> <span class="n">PLAN</span>                                                <span class="o">|</span>
<span class="o">+</span><span class="c1">-----------------------------------------------------+</span>
<span class="o">|</span> <span class="n">EnumerableCalcRel</span><span class="p">(</span><span class="n">expr</span><span class="o">#</span><span class="mi">0</span><span class="p">..</span><span class="mi">9</span><span class="o">=</span><span class="p">[</span><span class="err">{</span><span class="n">inputs</span><span class="err">}</span><span class="p">],</span> <span class="n">NAME</span><span class="o">=</span><span class="p">[</span><span class="err">$</span><span class="n">t1</span><span class="p">])</span> <span class="o">|</span>
<span class="o">|</span>   <span class="n">CsvTableScan</span><span class="p">(</span><span class="k">table</span><span class="o">=</span><span class="p">[[</span><span class="n">SALES</span><span class="p">,</span> <span class="n">EMPS</span><span class="p">]])</span>               <span class="o">|</span>
<span class="o">+</span><span class="c1">-----------------------------------------------------+</span>
</code></pre></div>
<p>What causes the difference in plan? Let&#39;s follow the trail of evidence. In the
<code>smart.json</code> model file, there is just one extra line:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="err">flavor:</span> <span class="s2">&quot;translatable&quot;</span>
</code></pre></div>
<p>This causes a <code>CsvSchema</code> to be created with
<code>flavor = TRANSLATABLE</code>,
and its <code>createTable</code> method creates instances of
<a href="../example/csv/src/main/java/org/apache/calcite/adapter/csv/CsvTranslatableTable.java">CsvTranslatableTable</a>
rather than a <code>CsvScannableTable</code>.</p>

<p><code>CsvTranslatableTable</code> implements the
<code><a href="http://www.hydromatic.net/calcite/apidocs/org/apache/calcite/schema/TranslatableTable.html#toRel()">TranslatableTable.toRel()</a></code>
method to create
<a href="../example/csv/src/main/java/org/apache/calcite/adapter/csv/CsvTableScan.java">CsvTableScan</a>.
Table scans are the leaves of a query operator tree.
The usual implementation is
<code><a href="http://www.hydromatic.net/calcite/apidocs/org/apache/calcite/adapter/enumerable/EnumerableTableScan.html">EnumerableTableScan</a></code>,
but we have created a distinctive sub-type that will cause rules to fire.</p>

<p>Here is the rule in its entirety:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CsvProjectTableScanRule</span> <span class="kd">extends</span> <span class="n">RelOptRule</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">CsvProjectTableScanRule</span> <span class="n">INSTANCE</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nf">CsvProjectTableScanRule</span><span class="o">();</span>

  <span class="kd">private</span> <span class="nf">CsvProjectTableScanRule</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span>
        <span class="n">operand</span><span class="o">(</span><span class="n">Project</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">operand</span><span class="o">(</span><span class="n">CsvTableScan</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">none</span><span class="o">())),</span>
        <span class="s">&quot;CsvProjectTableScanRule&quot;</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMatch</span><span class="o">(</span><span class="n">RelOptRuleCall</span> <span class="n">call</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">Project</span> <span class="n">project</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="na">rel</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">CsvTableScan</span> <span class="n">scan</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="na">rel</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="kt">int</span><span class="o">[]</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">getProjectFields</span><span class="o">(</span><span class="n">project</span><span class="o">.</span><span class="na">getProjects</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">fields</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Project contains expressions more complex than just field references.</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">call</span><span class="o">.</span><span class="na">transformTo</span><span class="o">(</span>
        <span class="k">new</span> <span class="nf">CsvTableScan</span><span class="o">(</span>
            <span class="n">scan</span><span class="o">.</span><span class="na">getCluster</span><span class="o">(),</span>
            <span class="n">scan</span><span class="o">.</span><span class="na">getTable</span><span class="o">(),</span>
            <span class="n">scan</span><span class="o">.</span><span class="na">csvTable</span><span class="o">,</span>
            <span class="n">fields</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">int</span><span class="o">[]</span> <span class="nf">getProjectFields</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">RexNode</span><span class="o">&gt;</span> <span class="n">exps</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">fields</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">exps</span><span class="o">.</span><span class="na">size</span><span class="o">()];</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">exps</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="kd">final</span> <span class="n">RexNode</span> <span class="n">exp</span> <span class="o">=</span> <span class="n">exps</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">exp</span> <span class="k">instanceof</span> <span class="n">RexInputRef</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">fields</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="o">((</span><span class="n">RexInputRef</span><span class="o">)</span> <span class="n">exp</span><span class="o">).</span><span class="na">getIndex</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// not a simple projection</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">fields</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>The constructor declares the pattern of relational expressions that will cause
the rule to fire.</p>

<p>The <code>onMatch</code> method generates a new relational expression and calls
<code><a href="http://www.hydromatic.net/calcite/apidocs/org/apache/calcite/plan/RelOptRuleCall.html#transformTo(org.apache.calcite.rel.RelNode)">RelOptRuleCall.transformTo()</a></code>
to indicate that the rule has fired successfully.</p>

<h2 id="the-query-optimization-process">The query optimization process</h2>

<p>There&#39;s a lot to say about how clever Calcite&#39;s query planner is, but we won&#39;t
say it here. The cleverness is designed to take the burden off you, the writer
of planner rules.</p>

<p>First, Calcite doesn&#39;t fire rules in a prescribed order. The query optimization
process follows many branches of a branching tree, just like a chess playing
program examines many possible sequences of moves. If rules A and B both match a
given section of the query operator tree, then Calcite can fire both.</p>

<p>Second, Calcite uses cost in choosing between plans, but the cost model doesn&#39;t
prevent rules from firing which may seem to be more expensive in the short term.</p>

<p>Many optimizers have a linear optimization scheme. Faced with a choice between
rule A and rule B, as above, such an optimizer needs to choose immediately. It
might have a policy such as &quot;apply rule A to the whole tree, then apply rule B
to the whole tree&quot;, or apply a cost-based policy, applying the rule that
produces the cheaper result.</p>

<p>Calcite doesn&#39;t require such compromises.
This makes it simple to combine various sets of rules.
If, say you want to combine rules to recognize materialized views with rules to
read from CSV and JDBC source systems, you just give Calcite the set of all
rules and tell it to go at it.</p>

<p>Calcite does use a cost model. The cost model decides which plan to ultimately
use, and sometimes to prune the search tree to prevent the search space from
exploding, but it never forces you to choose between rule A and rule B. This is
important, because it avoids falling into local minima in the search space that
are not actually optimal.</p>

<p>Also (you guessed it) the cost model is pluggable, as are the table and query
operator statistics it is based upon. But that can be a subject for later.</p>

<h2 id="jdbc-adapter">JDBC adapter</h2>

<p>The JDBC adapter maps a schema in a JDBC data source as a Calcite schema.</p>

<p>For example, this schema reads from a MySQL &quot;foodmart&quot; database:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="err">version:</span> <span class="err">&#39;1.0&#39;,</span>
  <span class="err">defaultSchema:</span> <span class="err">&#39;FOODMART&#39;,</span>
  <span class="err">schemas:</span> <span class="err">[</span>
    <span class="err">{</span>
      <span class="err">name:</span> <span class="err">&#39;FOODMART&#39;,</span>
      <span class="err">type:</span> <span class="err">&#39;custom&#39;,</span>
      <span class="err">factory:</span> <span class="err">&#39;org.apache.calcite.adapter.jdbc.JdbcSchema$Factory&#39;,</span>
      <span class="err">operand:</span> <span class="err">{</span>
        <span class="err">jdbcDriver:</span> <span class="err">&#39;com.mysql.jdbc.Driver&#39;,</span>
        <span class="err">jdbcUrl:</span> <span class="err">&#39;jdbc:mysql://localhost/foodmart&#39;,</span>
        <span class="err">jdbcUser:</span> <span class="err">&#39;foodmart&#39;,</span>
        <span class="err">jdbcPassword:</span> <span class="err">&#39;foodmart&#39;</span>
      <span class="p">}</span>
    <span class="err">}</span>
  <span class="err">]</span>
<span class="err">}</span>
</code></pre></div>
<p>(The FoodMart database will be familiar to those of you who have used
the Mondrian OLAP engine, because it is Mondrian&#39;s main test data
set. To load the data set, follow <a
href="http://mondrian.pentaho.com/documentation/installation.php#2_Set_up_test_data">Mondrian&#39;s
installation instructions</a>.)</p>

<p><b>Current limitations</b>: The JDBC adapter currently only pushes
down table scan operations; all other processing (filtering, joins,
aggregations and so forth) occurs within Calcite. Our goal is to push
down as much processing as possible to the source system, translating
syntax, data types and built-in functions as we go. If a Calcite query
is based on tables from a single JDBC database, in principle the whole
query should go to that database. If tables are from multiple JDBC
sources, or a mixture of JDBC and non-JDBC, Calcite will use the most
efficient distributed query approach that it can.</p>

<h2 id="the-cloning-jdbc-adapter">The cloning JDBC adapter</h2>

<p>The cloning JDBC adapter creates a hybrid database. The data is
sourced from a JDBC database but is read into in-memory tables the
first time each table is accessed. Calcite evaluates queries based on
those in-memory tables, effectively a cache of the database.</p>

<p>For example, the following model reads tables from a MySQL
&quot;foodmart&quot; database:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="err">version:</span> <span class="err">&#39;1.0&#39;,</span>
  <span class="err">defaultSchema:</span> <span class="err">&#39;FOODMART_CLONE&#39;,</span>
  <span class="err">schemas:</span> <span class="err">[</span>
    <span class="err">{</span>
      <span class="err">name:</span> <span class="err">&#39;FOODMART_CLONE&#39;,</span>
      <span class="err">type:</span> <span class="err">&#39;custom&#39;,</span>
      <span class="err">factory:</span> <span class="err">&#39;org.apache.calcite.adapter.clone.CloneSchema$Factory&#39;,</span>
      <span class="err">operand:</span> <span class="err">{</span>
        <span class="err">jdbcDriver:</span> <span class="err">&#39;com.mysql.jdbc.Driver&#39;,</span>
        <span class="err">jdbcUrl:</span> <span class="err">&#39;jdbc:mysql://localhost/foodmart&#39;,</span>
        <span class="err">jdbcUser:</span> <span class="err">&#39;foodmart&#39;,</span>
        <span class="err">jdbcPassword:</span> <span class="err">&#39;foodmart&#39;</span>
      <span class="p">}</span>
    <span class="err">}</span>
  <span class="err">]</span>
<span class="err">}</span>
</code></pre></div>
<p>Another technique is to build a clone schema on top of an existing
schema. You use the <code>source</code> property to reference a schema
defined earlier in the model, like this:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="err">version:</span> <span class="err">&#39;1.0&#39;,</span>
  <span class="err">defaultSchema:</span> <span class="err">&#39;FOODMART_CLONE&#39;,</span>
  <span class="err">schemas:</span> <span class="err">[</span>
    <span class="err">{</span>
      <span class="err">name:</span> <span class="err">&#39;FOODMART&#39;,</span>
      <span class="err">type:</span> <span class="err">&#39;custom&#39;,</span>
      <span class="err">factory:</span> <span class="err">&#39;org.apache.calcite.adapter.jdbc.JdbcSchema$Factory&#39;,</span>
      <span class="err">operand:</span> <span class="err">{</span>
        <span class="err">jdbcDriver:</span> <span class="err">&#39;com.mysql.jdbc.Driver&#39;,</span>
        <span class="err">jdbcUrl:</span> <span class="err">&#39;jdbc:mysql://localhost/foodmart&#39;,</span>
        <span class="err">jdbcUser:</span> <span class="err">&#39;foodmart&#39;,</span>
        <span class="err">jdbcPassword:</span> <span class="err">&#39;foodmart&#39;</span>
      <span class="p">}</span>
    <span class="err">},</span>
    <span class="p">{</span>
      <span class="err">name:</span> <span class="err">&#39;FOODMART_CLONE&#39;,</span>
      <span class="err">type:</span> <span class="err">&#39;custom&#39;,</span>
      <span class="err">factory:</span> <span class="err">&#39;org.apache.calcite.adapter.clone.CloneSchema$Factory&#39;,</span>
      <span class="err">operand:</span> <span class="err">{</span>
        <span class="err">source:</span> <span class="err">&#39;FOODMART&#39;</span>
      <span class="p">}</span>
    <span class="err">}</span>
  <span class="err">]</span>
<span class="err">}</span>
</code></pre></div>
<p>You can use this approach to create a clone schema on any type of
schema, not just JDBC.</p>

<p>The cloning adapter isn&#39;t the be-all and end-all. We plan to develop
more sophisticated caching strategies, and a more complete and
efficient implementation of in-memory tables, but for now the cloning
JDBC adapter shows what is possible and allows us to try out our
initial implementations.</p>

<h2 id="further-topics">Further topics</h2>

<h3 id="defining-a-custom-schema">Defining a custom schema</h3>

<p>(To be written.)</p>

<h3 id="modifying-data">Modifying data</h3>

<p>How to enable DML operations (INSERT, UPDATE and DELETE) on your schema.</p>

<p>(To be written.)</p>

<h3 id="calling-conventions">Calling conventions</h3>

<p>(To be written.)</p>

<h3 id="statistics-and-cost">Statistics and cost</h3>

<p>(To be written.)</p>

<h3 id="defining-and-using-user-defined-functions">Defining and using user-defined functions</h3>

<p>(To be written.)</p>

<h3 id="defining-tables-in-a-schema">Defining tables in a schema</h3>

<p>(To be written.)</p>

<h3 id="defining-custom-tables">Defining custom tables</h3>

<p>(To be written.)</p>

<h3 id="built-in-sql-implementation">Built-in SQL implementation</h3>

<p>How does Calcite implement SQL, if an adapter does not implement all of the core
relational operators?</p>

<p>(To be written.)</p>

<h3 id="table-functions">Table functions</h3>

<p>(To be written.)</p>

<h2 id="further-resources">Further resources</h2>

<ul>
<li><a href="http://calcite.incubator.apache.org">Apache Calcite</a> home
page</li>
</ul>


                    </div>
                
            </div>

            

            <div class=row-fluid>
                <div id=footer class=span12>
                    Copyright © 2014  <a href="http://www.apache.org">Apache Software Foundation</a>. All Rights Reserved. 

                </div>
            </div>
        </div>

        <script>
            function orderNav() {
                var list,
                    section,
                    header,
                    sections = [],
                    lists = {},
                    headers = {};

                var navUl = document.querySelectorAll('#navigation ul')[0],
                    navLis = document.querySelectorAll('#navigation ul li');

                if (!navUl) return;

                for (var i = 0; i < navLis.length; i++) {
                    var order, li = navLis[i];

                    if (li.classList.contains('nav-header')) {
                        section = li.textContent || li.innerText;
                        sections.push(section);
                        headers[section] = li;
                        continue;
                    }

                    if (!lists[section]) {
                        lists[section] = [];
                    }

                    order = parseFloat(li.getAttribute('data-order'))
                    lists[section].push([order, li]);
                }

                for (var i = 0; i < sections.length; i++) {
                    section = sections[i];
                    list = lists[section].sort(function(a, b) {
                        return a[0] - b[0];
                    });

                    if (header = headers[section]) {
                        navUl.appendChild(header);
                    }
                    for (var j = 0; j < list.length; j++) {
                        navUl.appendChild(list[j][1]);
                    }
                }
            }

            if (document.querySelectorAll) orderNav();
        </script>
        
    </body>
</html>
